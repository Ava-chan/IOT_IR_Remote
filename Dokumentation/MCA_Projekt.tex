\input{Header/Header}						

\begin{document}


\title{Entwicklung eines IR-Empfänger und -Sender mit dem ESP8266}
\subtitle{Dokumentation: Microcontroller-Anwendungs-Projekt}
\author{} %TODO Später hinzufügen
\date{\today}

\maketitle

\tableofcontents										% Inhaltsverzeichnis
\pagebreak
%\listoffigures											% Abbildungsverzeichnis
%\pagebreak
%\listoftables											% Tabellenverzeichnis
%\pagebreak

\section{Einleitung}
\subsection{Ausgangspunkt}
Der Ausgangspunkt des Projektes ist die Absicht eine Infrarot-Fernbedingung mit Hilfe eines Mikrocontrollers zu realisieren. Im Rahmen des aktuellen Hype um \acs{IoT} stellt diese Anforderung für uns eine interessante Möglichkeit da, bisher nicht \acs{IoT} fähige, über Infrarot Fernbedienung gesteuerten Geräten diese Funktion ``nachzurüsten''. Hierdurch soll die Ansteuerung der Geräte wesentlich individueller belegbar sein, ohne dass, wie in anderen schon vorhanden Lösungen, (z.B. Logitech Harmony - \url{http://www.logitech.com/de-de/harmony-remotes}) eine neue Fernbedienung die alte ersetzt. Vielmehr soll ein schon vorhandenes Gerät/vorhandene Geräte diese Aufgabe mit übernehmen können.

Zur Umsetzung dieses Vorhabens bietet sich der Mikrocontroller ESP8266 an.
Er ist preiswert und besitzt ein integriertes WLAN-Modul.

\subsection{Ziele}
%TODO Vollständig?
Ziel des Projektes ist es, eine Schaltung einschließlich dazugehöriger Mikrocontroller-Software zu entwickeln, die folgende Funktionen bietet:

\begin{itemize}
	\item Mikrocontroller muss die Dienste eines Webservers bereitstellen
	\item Kommunikation mit ESP8266 über drahtloses Netzwerk
	\item AccessPoint zur Konfiguration des ESP8266
	\item Einwahl in vorhandenes drahtloses Netzwerk und Speichern der Einwahldaten
	\item Steuerung des ESP8266 über Website
	\item Erfassen, Speichern und Ausgabe von Infrarot-Signalen (38kHz)
\end{itemize}

Alle diese Ziele sind mit Hilfe eines ESP8266 und weiterer Komponenten realisierbar.

\section{Grundlagen}
\subsection{Der ESP8266}
%TODO Ausreichend?
Der ESP8266 ist ein kostengünstiges, programmierbares \ac{SoC} mit einer \acs{WLAN}, \acs{UART}-und \acs{SPI}-Schnittstelle.
Ursprünglich wurde dieser \acs{SoC} von Espressif (daher ESP) entwickelt und verkauft, inzwischen bieten aber verschiedene andere Hersteller ebenfalls Varianten vom ESP8266 bzw. dem erweiterten ESP8266EX an.
Diese sind ab einem Stückpreis von ca. 2,00 € z.B. über AliExpress (\url{http://www.aliexpress.com}) verfügbar.

Nachfolgend ist die Spezifikation eines ESP8266 laut Espressif gelistet:

%TODO - Halbwegs auf deutsch übersetzen ... oder komplett in english (NICHT 5V TOLERANT)
\begin{itemize}
    \item Wi-Fi Standards: 802.11 b/g/n, Wi-Fi Direct (\acs{P2P}), \acs{soft-AP}
    \item Integrierter TCP/IP Protokollstack
    \item Integrierter \acs{T/R} switch, \acs{balun}, \acs{LNA}, power amplifier and matching network
    \item Integrierte \acs{PLL}s, \acs{DCXO} und Spannungsversorgung
    \item +19.5dBm Ausgangsleistung im 802.11b Modus
    \item Power down leakage current of <10$\mu$A
    \item Integrierte verbrauchsarme 32-bit CPU (80 MHz)
    \item \acs{SDIO} 1.1/2.0, \acs{SPI}, \acs{UART}
    \item \acs{STBC}, 2×1 \acs{MIMO}
    \item \acs{A-MPDU} \& \acs{A-MSDU} aggregation \& 0.4ms guard interval
    \item Aufwachen und übermitteln von Paketen in < 2ms
    \item Standby Leistungsaufnahme < 1.0mW (\acs{DTIM3})
    \item\acs{VCC}: 3,3V (Nicht 5V tolerant)
    \item Flash Größe: 512kB - 4MB 
\end{itemize}
(Quelle: \url{http://www.mikrocontroller.net/articles/ESP8266} ; Stand: 18.01.2016)
Verfügbare Flash-Größe, Arbeitsspeicher und CPU-Frequenz sind Modell und Hersteller abhängig. Häufig wird die versendete Form innerhalb des online Angebots nicht genauer beschrieben.

In der \autoref{fig:ESP8266} ist ein ESP8266 mit dem dazugehörigen Pinlayout dargestellt.

\begin{figure}
	\centering
	\begin{minipage}{0.45\textwidth}
			\includegraphics[scale=1.5]{Abbildungen/ESP8266A}
	\end{minipage}
	\hfill
	\begin{minipage}{0.45\textwidth} 
			\includegraphics[scale=1.5]{Abbildungen/ESP8266}
	\end{minipage}
	\caption{ESP8266 Platine und Schaltung}
	\label{fig:ESP8266}
\end{figure}

\subsection{Programmierung}
%TODO Ausreichend?
Die Programmierung des Mikrocontrollers kann mit der Arduino IDE erfolgen. Hierzu muss das Community Package esp8266 installiert sein, welches zusätzliche Header und Funktionen, sowie Compiler und Programmierdefinitionen beinhaltet.
In IDE kann mit einer C/C++-Syntax programmiert werden, wobei der Compiler einige aber nicht alle Befehlssätze des C++11 Standards unterstützt.
Zu finden ist diese IDE unter \url{https://www.arduino.cc/} (Stand: 18.01.2016).

Weiterhin wird der ESP8266 über die \acs(TXD)- und \acs(RXD)-Leitungen mit Hilfe des \acs{UART}-Protokolls programmiert.
Damit der Controller in den Programmiermodus wechselt, muss beim Start der \acs{GPIO}\_0 auf Masse liegen (Controller startet im Programmiermodus).
Anschließend kann die durch Cross-Compiling erzeugte Binary von der Arduino IDE an den ESP8266 übertragen werden.
Für die Programmierung bieten sich beispielsweise sogenannte USB-to-\acs{UART}-Programmierkabel an (z.B. der PL2303).
Hierbei ist zu beachten, dass die Spannungsversorgung am Ausgang der meisten Programmierkabel 5V und nicht 3.3V beträgt. Der Mikrocontroller ist nicht 5V tolerant.

\subsection{Funktionsweise Infrarot}
%TODO Ausreichend?
Damit eine WLAN-gesteuerte Infrarotfernbedingung realisiert werden kann, müssen zunächst die Grundlagen einer solchen Fernbedingung kurz erklärt werden.

Eine Infrarot-Fernbedienung sendet über eine Infrarotleuchtdiode ein Signal im Infrarotbereich.
Dieses Signal wird mit einer bestimmten Trägerfrequenz gesendet.
Viele Fernbedingungen arbeiten beispielsweise mit einer Trägerfrequenz von 38kHz.
Es existieren aber Fernbedingungen, welche andere Frequenzen nutzen.
In diesem Projekt wird eine Fernbedingung mit 38kHz realisiert.
Es ist wichtig sich auf eine Frequenz festzulegen, da die Frequenz Einfluss auf Bauteile und Programmierung hat.

Über eine \textbf{P}uls-\textbf{W}eiten-\textbf{M}odulation (PWM) auf der Trägerfrequenz wird das codierte Signal übertragen.
Jede Taste auf einer Fernbedingung besitzt eine eigene Codierung.
Weiterhin existieren verschiedene Protokolle zur Codierung von Signalen.
Die Protokolle werden in diesem Projekt vernachlässigt, da die Codierung im Wesentlichen nur kopiert und gespeichert wird.

Damit das Infrarotsignal empfangen werden kann, wird ein entsprechender Empfänger benötigt.
Solche Empfänger sind als integrierte Schaltkreise verfügbar, welche alle benötigten Funktionen in einem Bauteil vereinen.
Ein Infrarotempfänger besteht aus einer Fotodiode, einem geregeltem Verstärker, welcher entsprechend der Frequenz arbeitet (zum Beispiel 38kHz) und einem Demodulator.
Der Demodulator sendet das digital codierte Signal an den Mikrocontroller.
Weiterhin besitzt der integrierte Schaltkreis einen Bandpassfilter um Störungen von anderen Frequenzen als der gewünschten Frequenz zu vermeiden.
Meist sind Fotodiode und Schaltkreis in einem Kunststoffgehäuse integriert.
Der TSOP4836 ist zum Beispiel solch ein Empfänger für die Trägerfrequenz von 38kHz.

Auf die konkreten Details zu PWM wird in dieser Dokumentation nicht eingegangen.

\section{Realisierung}
Nachdem die Grundlagen für das Projekt betrachtet wurden, soll nun die konkrete Realisierung des Projektes verdeutlicht werden.

\subsection{Aufbau}
%TODO Vollständig?
Die \autoref{fig:Schalplan} zeigt den Schaltplan für die Realisierung einer Infrarot-Fernbedingung inklusive Empfänger.

\begin{figure}
	\centering
	\includegraphics[scale=1]{Abbildungen/ESP8266_Schaltplan}
	\caption{Schaltplan}
	\label{fig:Schalplan}
\end{figure}

Für die Programmierung des Mikrocontrollers wird ein USB-to-UART-Programmierer (PL2303) verwendet.
Dieser liefert an VCC 5V.
Der ESP8266 selbst benötigt 3,3V und ist nicht 5V tolerant, sodass ein fester Spannungsregler verwendet wird um 3,3V für den Mikrocontroller zur Verfügung zu stellen.
Als Spannungsregler bietet sich zum Beispiel der LM1117-3V3 (verwendet) oder ein L7805 an.
%http://www.ti.com/lit/ds/symlink/lm1117.pdf
Der Spannungsregler ist im Schaltplan als 78XX dargestellt.
Zur Spannungsstabilisierung besitzt der Spannungsregler zwischen dem 3,3V-Ausgang und Masse einen 10$\mu$F-Kondensator.

Nun wird für den ESP8266 die benötigte Spannung von 3,3V bereitgestellt.
Die Pins VCC und CH\_PD (Chip Power Down) werden mit der Spannungsquelle 3,3V verbunden und GND entsprechend auf Masse gelegt.
Der RST-Pin (Reset) wird mit einem Taster verbunden, welcher bei betätigen diesen Pin auf Masse zieht (interner Pull Up) und somit den Mikrocontroller zurücksetzt.

Das ESP8266-Modul besitzt 2 Digitale Ein beziehungsweise Ausgänge. GPIO\_0 benutzen wir als Ausgang und GPIO\_2 benutzen wir als Eingang.
Wie diese Pins arbeiten wird bei der Programmierung festgelegt.

An dem GPIO\_0 ist ein DIP-Schalter angeschlossen.
Dieser dient dazu zwischen dem Programmiermodus und dem normalen Modus zu Wechseln.
Der Pin ist Low-Aktiv, sodass für den normalen Betrieb und nach einem Reset immer 3,3V anliegen muss.
Für das Programmieren wird dieser PIN auf Masse gezogen in dem der Schalter entsprechend gesetzt wird und ein Reset ausgeführt wird.
Andernfalls ist der DIP-Schalter mit einer Infrarotdiode (1,5V, 80mA) inklusive Vorwiederstand(22 Ohm) verbunden.
Die Diode und der Widerstand sind mit der 3,3V Spannungsquelle verbunden.
Diese Diode dient später dazu die Infrarotsignale zu senden.

Der GPIO\_0 2 wird mit dem Infrarotempfänger verbunden und dient zur Erfassung der Infrarot-Signale.
Der Infrarotempfänger wird entsprechend mit der 3,3V Spannungsquelle und der Masse verbunden.

Aufgrund das Senden und Empfangen nicht gleichzeitig möglich sind, bedarf es keiner Abschirmung zwischen Sender und Empfänger.

Die \autoref{fig:Steckplatine} zeigt den Aufbau auf einer Steckplatine.

\begin{figure}
	\centering
	\includegraphics[scale=1]{Abbildungen/ESP8266_Steckplatine}
	\caption{Steckplatine}
	\label{fig:Steckplatine}
\end{figure}


\subsection{Implementierung}
%TODO Programmablaufplan
%TODO Noch zu vervollständigen

\subsubsection{Infrarotsignale Empfangen}
%TODO erklären ?? Wie funktioniert das?
\subsubsection{Infrarotsignale Senden}
Damit Infrarotsignale mit einer Trägerfrequenz von 38kHz gesendet werden, bedarf es einem Trick in der Programmierung um dies zu realisieren.
Dies geschieht in dem der digitale Ausgang GPIO\_2 zwischen einer logischen 1 und 0 alterniert.
Die Länge des Pulses beschreibt den gesendeten Befehl an den Infrarotempfänger.

Dies kann mit Hilfe eines $\mu$s-delay Befehl realisiert werden.
Jeder Puls ist 1/38000 Sekunden (26,3 $\mu$s) lang.
Gerundet auf 26 $\mu$s ist die Modulationsfrequenz realisierbar mit:
%TODO Pseudocode wenn fertig

\subsection{Verwendung}
%TODO Screenshots browser (wäre cool, wenn du das machst Eike.., da bei mir der Mikrocontroller nachwievor rumzickt..) , verwendung beschreiben
%TODO Herr Bastian mag es, wenn ALLES gelernte in das Fazit / Zusammenfassung einfließt-> Fazit darf ruhig mehrere Seiten lang sein!!
%TODO Bitte ergänze das hier bitte mit @ Eike
%TODO Vervollständigen
\section{Fazit}

Im Verlaufe des Projektes ist eine über ein drahtloses Netzwerk steuerbare Mikrocontroller-Anwendung entstanden, welcher in einem heimischen Netzwerk verwendet werden kann.

Erworbene Fertigkeiten:
\begin{itemize}
	\item Programmierung in einer Arduino IDE inklusive entsprechender Konfiguration der IDE
	\item Programmierung in C/C++ ähnlicher Sprache
	\item Umgang mit dem ESP8266
	\item Erworbenes Verständnis für die Funktionsweise von Infrarotsendern und Empfängern
\end{itemize} 

Es ist in der gewählten Realisierung nicht möglich Stromsparmaßnahmen des Mikrocontrollers zu verwenden.
Dies ist damit begründet, das die drahtlose Netzwerkverbindung permanent aufrecht gehalten werden muss.
Verwendung von Stromsparmaßnahmen würde dazu führen, dass das Modul die Verbindung zum Netzwerk verliert und anschließend nicht erreichbar ist.
Begründet ist dies damit, da die Steuerung über den Webserver des Moduls erfolgt.

Der Quellcode für das Projekt ist auf GitHub verfügbar unter:\\ \url{https://github.com/Ava-chan/IOT_IR_Remote}

\pagebreak
%TODO footmarks für quellen und erklärungen von begriffen
\begin{appendix}
\pagestyle{empty}	
\section{Abkürzungsverzeichnis}

\begin{acronym}
\acro{A-MPDU}{}
\acro{A-MSDU}{}
\acro{balun}{\textbf{bal}anced-\textbf{un}balanced}{ - Wandler zwischen symmetrischen und unsymmetrischen Leistungssystemen}
\acro{DCXO}{Digitally Controlled MEMS Oscillators}{ - digital gesteuerter Quarzoszillator}
\acro{DTIM3}{}
\acro{GPIO}{}
\acro{IoT}{Internet of Things}{- ``intelligente Gegenstände'' unterstützen Menschen unmerklich}
\acro{LNA}{\textbf{L}ow \textbf{N}oise \textbf{A}mplifier}{ - Rausch armer Verstärker}
\acro{MIMO}{}
\acro{P2P}{Peer to Peer}{ - Direkte Endgerät zu Endgerät Kommunikation OHNE Access Point}
\acro{PLL}{} %TODO Ich weiß nicht was es ist
\acro{RXD}{}
\acro{soft-AP}{software enabled access point}{- ein über Software erstellter Access Point, welcher auf einem Gerät erzeugt wird welches nicht speziell als Router gedacht ist}
\acro{SDIO}{Secure Digital Input Output}{ - SD-Interface um Peripheriegeräte (z.B. Webcam, GPS, Ethernet, ...) anzusprechen}
\acro{SPI}{}
\acro{SoC}{System-on-a-Chip}{ - Integration aller Systeme in einem Chip / einem Bauteil}
\acro{STBC}{}
\acro{T/R}{Transmit / Receive}{ - Versenden und Empfangen von Signalen}
\acro{TXD}{}
\acro{UART}{}
\acro{VCC}{Voltage at the common collector} {- Versorgungsspannung}
\acro{WLAN}{Wireless Local Area Network}{ - engl. auch WiFi - kabellose Netzwerkverbindung}
\end{acronym}
\end{appendix}

\end{document}